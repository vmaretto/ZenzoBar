<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenzoBar Orders</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase v9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        
        // üî• TUA CONFIGURAZIONE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAlYaxfd7JScPfwayxUF6um5fbU2CQ8SWg",
            authDomain: "zenzobar-edbdc.firebaseapp.com", 
            projectId: "zenzobar-edbdc",
            storageBucket: "zenzobar-edbdc.firebasestorage.app",
            messagingSenderId: "408846717271",
            appId: "1:408846717271:web:53e2132f8370b9eb325612"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Rendi Firebase globale per l'app
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseOnSnapshot = onSnapshot;
        
        console.log('üî• Firebase inizializzato con successo!');
        
        // Notifica che Firebase √® pronto
        window.dispatchEvent(new Event('firebaseReady'));
    </script>
</head>
<body>
    <div id="app">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-orange-500 mx-auto"></div>
                <p class="mt-4 text-gray-600">Caricamento ZenzoBar...</p>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Service
        class FirebaseService {
            constructor() {
                this.db = null;
                this.listeners = [];
                this.isInitialized = false;
                
                // Attendi che Firebase sia caricato
                if (window.firebaseDb) {
                    this.initializeFirebase();
                } else {
                    window.addEventListener('firebaseReady', () => {
                        this.initializeFirebase();
                    });
                }
            }
            
            initializeFirebase() {
                this.db = window.firebaseDb;
                this.isInitialized = true;
                console.log('üî• FirebaseService pronto!');
                
                // Notifica i listeners che Firebase √® pronto
                this.listeners.forEach(listener => {
                    this.setupRealListener(listener);
                });
            }
            
            async setupRealListener(listener) {
                if (!this.isInitialized || !this.db) return;
                
                try {
                    const docRef = window.firebaseDoc(this.db, 'zenzobar', listener.path);
                    
                    const unsubscribe = window.firebaseOnSnapshot(docRef, (docSnap) => {
                        console.log(`üî• Firebase update per ${listener.path}`);
                        const data = docSnap.exists() ? docSnap.data().value : this.getDefaultValue(listener.path);
                        listener.callback(data);
                    }, (error) => {
                        console.error(`‚ùå Errore listener Firebase per ${listener.path}:`, error);
                    });
                    
                    listener.unsubscribe = unsubscribe;
                } catch (error) {
                    console.error('Errore setup listener Firebase:', error);
                }
            }
            
            getDefaultValue(path) {
                switch(path) {
                    case 'activeOrders':
                    case 'orderHistory':
                    case 'tables':
                        return [];
                    case 'orders':
                        return {};
                    default:
                        return {};
                }
            }
            
            onSnapshot(path, callback) {
                const listener = { path, callback };
                this.listeners.push(listener);
                
                if (this.isInitialized) {
                    this.setupRealListener(listener);
                } else {
                    // Se Firebase non √® ancora pronto, restituisci valori default
                    const currentData = this.getDefaultValue(path);
                    callback(currentData);
                }
                
                return () => {
                    this.listeners = this.listeners.filter(l => l.callback !== callback);
                    if (listener.unsubscribe) {
                        listener.unsubscribe();
                    }
                };
            }
            
            async update(path, newData) {
                console.log(`üîÑ Aggiornamento: ${path}`, newData);
                
                if (this.isInitialized && this.db) {
                    try {
                        const docRef = window.firebaseDoc(this.db, 'zenzobar', path);
                        await window.firebaseSetDoc(docRef, { value: newData, timestamp: new Date() });
                        console.log(`üî• Firebase aggiornato: ${path}`);
                    } catch (error) {
                        console.error(`‚ùå Errore aggiornamento Firebase per ${path}:`, error);
                    }
                } else {
                    console.log('Firebase non ancora pronto, aggiornamento in coda...');
                }
            }
            
            getConnectionState() {
                return this.isInitialized && navigator.onLine;
            }
        }
        
        const firebaseService = new FirebaseService();
        
        // ZenzoBar App
        class ZenzoBarApp {
            constructor() {
                this.state = {
                    currentView: 'tables',
                    selectedTable: null,
                    orders: {},
                    orderHistory: [],
                    activeOrders: [],
                    showSettings: false,
                    tableCount: 8,
                    customTables: [],
                    editingTable: null,
                    isOnline: true,
                    syncStatus: 'Inizializzazione...'
                };
                
                this.init();
            }
            
            init() {
                this.setupFirebaseListeners();
                this.render();
                
                // Connection check
                setInterval(() => {
                    const online = firebaseService.getConnectionState();
                    this.setState({ isOnline: online });
                    if (!online) {
                        this.setState({ syncStatus: 'üî¥ Offline' });
                    }
                }, 5000);
            }
            
            setupFirebaseListeners() {
                this.setState({ syncStatus: 'üîÑ Connessione Firebase...' });
                
                try {
                    const unsubscribeOrders = firebaseService.onSnapshot('orders', (data) => {
                        console.log('üì® Ricevuti orders:', data);
                        this.setState({ orders: data || {}, syncStatus: 'üî• Sincronizzato Firebase' });
                    });

                    const unsubscribeActive = firebaseService.onSnapshot('activeOrders', (data) => {
                        console.log('üì® Ricevuti activeOrders:', data);
                        this.setState({ activeOrders: Array.isArray(data) ? data : [] });
                    });

                    const unsubscribeHistory = firebaseService.onSnapshot('orderHistory', (data) => {
                        console.log('üì® Ricevuti orderHistory:', data);
                        this.setState({ orderHistory: Array.isArray(data) ? data : [] });
                    });

                    const unsubscribeTables = firebaseService.onSnapshot('tables', (data) => {
                        console.log('üì® Ricevuti tables:', data);
                        if (Array.isArray(data) && data.length > 0) {
                            this.setState({ customTables: data });
                        }
                    });
                } catch (error) {
                    console.error('Errore setup Firebase listeners:', error);
                    this.setState({ syncStatus: '‚ùå Errore connessione' });
                }
            }
            
            setState(newState) {
                this.state = { ...this.state, ...newState };
                this.render();
            }
            
            // Menu categories
            get menuCategories() {
                return {
                    "Cocktail Analcolico": [
                        { id: 1, name: "Acqua Rinfrescante allo Zenzero", price: 6, ingredients: "Zenzero fresco Limone Miele Acqua fredda", description: "Fresco, dissetante, con le note pungenti dello zenzero." },
                        { id: 2, name: "Zenzapero", price: 6, ingredients: "Bevanda naturale allo zenzero Acqua tonica Zenzero fresco", description: "" },
                        { id: 3, name: "Hulky", price: 7, ingredients: "Kiwi Succo di mela Tonica Basilico fresco", description: "Verde brillante, carattere fresco. Mix energico e botanico." },
                        { id: 4, name: "Tropicana", price: 7, ingredients: "Succo Ananas Sciroppo di Cocco Succo Arancia", description: "Un sorso d'estate: ananas, cocco, arancia e tonica." }
                    ],
                    "Bevande": [
                        { id: 5, name: "Caff√®", price: 1.2, ingredients: "Caff√® in grani, acqua", description: "Miscela dal gusto pieno e rotondo." },
                        { id: 6, name: "Cappuccino", price: 1.5, ingredients: "Latte fresco, caff√®", description: "Un abbraccio caldo per iniziare la giornata." },
                        { id: 7, name: "Acqua naturale", price: 1, ingredients: "Acqua", description: "Acqua sempre disponibile." },
                        { id: 8, name: "Acqua gassata", price: 1, ingredients: "Acqua", description: "Acqua frizzante sempre disponibile." },
                        { id: 9, name: "Succo artigianale Ananas", price: 5, ingredients: "Ananas", description: "Preparato fresco ogni giorno." },
                        { id: 10, name: "Succo artigianale Mela", price: 5, ingredients: "Mela verde", description: "Solo mele fresche, lavorate da noi con cura." },
                        { id: 11, name: "Kombucha Cedro", price: 4.5, ingredients: "Acqua t√® nero Zucchero Coltura di Kombucha", description: "Cedro aspro, aromatico, irresistibile." },
                        { id: 12, name: "Smoothie Fragole", price: 5, ingredients: "Fragole e latte", description: "Cremoso, fresco, genuino." }
                    ],
                    "Cocktail": [
                        { id: 13, name: "CHIOSCO AL MARE", price: 15, ingredients: "Gin dry Vermouth bianco Cetriolo Lime", description: "Il nostro cocktail signature. Botanico e pulito." },
                        { id: 14, name: "Ginger Mule Light", price: 10, ingredients: "Vodka infusa allo zenzero Lime Ginger beer", description: "Classico con spirito Zenzo." },
                        { id: 15, name: "THE SALT", price: 15, ingredients: "Gin Artigianale Lime Sale della Cornovaglia", description: "Creato da Paolo Santoro. Sapido e vibrante." },
                        { id: 16, name: "Ginger Vodka & Tonic", price: 10, ingredients: "Vodka infusa allo zenzero Acqua tonica premium", description: "Essenziale, ma con carattere." }
                    ],
                    "Panino": [
                        { id: 17, name: "Calamarino", price: 6, ingredients: "Calamaro scottato zucchine grigliate menta", description: "Tenero, profumato. Estate pura in un morso." },
                        { id: 18, name: "Salmon Zeta", price: 6, ingredients: "Salmone affumicato avocado cipolla rossa", description: "Nordico, tropicale e Zenzo." },
                        { id: 19, name: "Fresco Zeta", price: 6, ingredients: "Avocado zenzero carote lattughino", description: "Completamente vegetale. Freschezza al 100%." }
                    ],
                    "Dolce": [
                        { id: 20, name: "Torta Zenzo Bar", price: 4, ingredients: "Pan di Spagna speziato crema diplomatica", description: "La torta firma di Zenzo Bar." },
                        { id: 21, name: "Cheesecake allo zenzero", price: 4, ingredients: "Formaggio spalmabile zenzero fresco", description: "Equilibrio tra cremosit√† e piccante." }
                    ]
                };
            }
            
            generateTableLayout(count) {
                const tables = [];
                for (let i = 0; i < count; i++) {
                    const seats = i % 3 === 0 ? 6 : i % 2 === 0 ? 4 : 2;
                    tables.push({ id: i + 1, number: i + 1, seats: seats });
                }
                return tables;
            }
            
            get tables() {
                return this.state.customTables.length > 0 ? this.state.customTables : this.generateTableLayout(this.state.tableCount);
            }
            
            getCurrentOrder() {
                return this.state.orders[this.state.selectedTable] || [];
            }
            
            async addToOrder(item) {
                const currentOrder = this.getCurrentOrder();
                const existingItem = currentOrder.find(orderItem => orderItem.id === item.id);
                
                const updatedTableOrders = {
                    ...this.state.orders,
                    [this.state.selectedTable]: existingItem
                        ? currentOrder.map(orderItem =>
                            orderItem.id === item.id
                                ? { ...orderItem, quantity: orderItem.quantity + 1 }
                                : orderItem
                          )
                        : [...currentOrder, { ...item, quantity: 1 }]
                };
                
                this.setState({ orders: updatedTableOrders });
                await firebaseService.update('orders', updatedTableOrders);
            }
            
            async removeFromOrder(itemId) {
                const currentOrder = this.getCurrentOrder();
                const updatedOrder = currentOrder.map(item =>
                    item.id === itemId
                        ? { ...item, quantity: Math.max(0, item.quantity - 1) }
                        : item
                ).filter(item => item.quantity > 0);

                const updatedTableOrders = {
                    ...this.state.orders,
                    [this.state.selectedTable]: updatedOrder
                };

                this.setState({ orders: updatedTableOrders });
                await firebaseService.update('orders', updatedTableOrders);
            }
            
            calculateTotal() {
                return this.getCurrentOrder().reduce((total, item) => total + (item.price * item.quantity), 0);
            }
            
            async printOrder() {
                const currentOrder = this.getCurrentOrder();
                if (currentOrder.length === 0) {
                    alert('Nessun articolo nell\'ordine!');
                    return;
                }

                this.setState({ syncStatus: 'üîÑ Invio in cucina...' });
                
                try {
                    const newOrder = {
                        id: Date.now(),
                        tableNumber: this.state.selectedTable,
                        items: [...currentOrder],
                        total: this.calculateTotal(),
                        timestamp: new Date(),
                        state: 'sent',
                        isModified: false,
                        version: 1
                    };
                    
                    const updatedActiveOrders = [...this.state.activeOrders, newOrder];
                    this.setState({ activeOrders: updatedActiveOrders });
                    await firebaseService.update('activeOrders', updatedActiveOrders);
                    
                    const clearedOrders = { ...this.state.orders };
                    delete clearedOrders[this.state.selectedTable];
                    this.setState({ orders: clearedOrders });
                    await firebaseService.update('orders', clearedOrders);
                    
                    this.setState({ syncStatus: 'üî• Sincronizzato Firebase' });
                    alert('‚úÖ ORDINE INVIATO IN CUCINA!');
                    this.setState({ currentView: 'tables' });
                } catch (error) {
                    this.setState({ syncStatus: '‚ùå Errore invio' });
                    alert('‚ùå Errore durante l\'invio in cucina. Riprova.');
                }
            }
            
            closeOrderFromKitchen(orderId) {
    const orderToClose = this.state.activeOrders.find(order => order.id == orderId);
    
    if (!orderToClose) {
        alert('‚ùå Ordine non trovato!');
        return;
    }

    const closedOrder = {
        ...orderToClose,
        state: 'paid',
        closedAt: new Date(),
        closedBy: 'kitchen'
    };
    
    const updatedHistory = [closedOrder, ...this.state.orderHistory];
    const updatedActiveOrders = this.state.activeOrders.filter(order => order.id != orderId);
    
    this.setState({ 
        orderHistory: updatedHistory,
        activeOrders: updatedActiveOrders
    });
    
    firebaseService.update('orderHistory', updatedHistory);
    firebaseService.update('activeOrders', updatedActiveOrders);
    
    alert(`‚úÖ Tavolo ${orderToClose.tableNumber} incassato e liberato!`);
}

            closeOrderFromWaiter(tableNumber) {
    const orderToClose = this.state.activeOrders.find(order => order.tableNumber == tableNumber);
    
    if (!orderToClose) {
        alert('‚ùå Nessun ordine attivo per questo tavolo!');
        return;
    }

    const confirmMsg = `‚ö†Ô∏è LIBERARE TAVOLO ${tableNumber}?\n\nATTENZIONE: Confermi che il cliente ha PAGATO?\n\nOrdine: ‚Ç¨${orderToClose.total.toFixed(2)}\nArticoli: ${orderToClose.items.reduce((sum, item) => sum + item.quantity, 0)}\n\nClicca OK solo se il cliente ha gi√† pagato.`;
    
    if (!window.confirm(confirmMsg)) {
        return;
    }

    const closedOrder = {
        ...orderToClose,
        state: 'paid',
        closedAt: new Date(),
        closedBy: 'waiter'
    };
    
    const updatedHistory = [closedOrder, ...this.state.orderHistory];
    const updatedActiveOrders = this.state.activeOrders.filter(order => order.id !== orderToClose.id);
    
    this.setState({
        orderHistory: updatedHistory,
        activeOrders: updatedActiveOrders
    });
    
    firebaseService.update('orderHistory', updatedHistory);
    firebaseService.update('activeOrders', updatedActiveOrders);
    
    alert(`‚úÖ Tavolo ${tableNumber} liberato dal cameriere!`);
}
            
            renderHistoryView() {
    return `
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Storico Ordini Chiusi</h1>
                <button onclick="app.setState({currentView: 'tables'})" class="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    ‚úï Chiudi
                </button>
            </div>
            
            ${this.state.orderHistory.length === 0 ? `
                <div class="text-center text-gray-500 mt-12">
                    <div class="text-6xl mb-4">üïê</div>
                    <p>Nessun ordine chiuso oggi</p>
                    <p class="text-sm text-gray-400 mt-2">Gli ordini pagati appariranno qui</p>
                </div>
            ` : `
                <div class="space-y-4">
                    ${this.state.orderHistory.map(order => `
                        <div class="bg-white rounded-lg shadow p-4 border">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">Tavolo ${order.tableNumber}</h3>
                                    <p class="text-gray-600 text-sm">Ordinato: ${new Date(order.timestamp).toLocaleString('it-IT')}</p>
                                    <p class="text-gray-600 text-sm">Chiuso: ${new Date(order.closedAt).toLocaleString('it-IT')}</p>
                                    <p class="text-blue-600 text-sm font-medium">
                                        Incassato da: ${order.closedBy === 'kitchen' ? 'üë®‚Äçüç≥ Cucina' : 'üë§ Cameriere'}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl font-bold text-green-600">‚Ç¨${order.total.toFixed(2)}</div>
                                    <div class="text-sm text-gray-500">${order.items.reduce((sum, item) => sum + item.quantity, 0)} articoli</div>
                                    <div class="text-xs text-green-600 font-medium mt-1">üí∞ PAGATO</div>
                                </div>
                            </div>
                            
                            <div class="border-t pt-3">
                                ${order.items.map(item => `
                                    <div class="flex justify-between text-sm mb-1">
                                        <span>${item.quantity}x ${item.name}</span>
                                        <span>‚Ç¨${(item.price * item.quantity).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `}
        </div>
    `;
}
            render() {
    const app = document.getElementById('app');
    
    if (this.state.currentView === 'tables') {
        app.innerHTML = this.renderTableView();
    } else if (this.state.currentView === 'menu') {
        app.innerHTML = this.renderMenuView();
    } else if (this.state.currentView === 'kitchen') {
        app.innerHTML = this.renderKitchenView();
    } else if (this.state.currentView === 'history') {
        app.innerHTML = this.renderHistoryView();
    }
    
    this.attachEventListeners();
}
            
            renderTableView() {
                return `
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">üî• Carita Morena X Zenzo Bar</h1>
                                <div class="text-sm text-gray-600 mt-1">
                                    ${this.state.syncStatus} ‚Ä¢ Multi-Device Ready
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="app.setState({currentView: 'kitchen'})" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                                    üë®‚Äçüç≥ Cucina
                                    ${this.state.activeOrders.length > 0 ? 
                                        `<span class="bg-yellow-400 text-red-800 rounded-full px-2 py-1 text-xs font-bold">${this.state.activeOrders.length}</span>` 
                                        : ''
                                    }
                                </button>
                                <button onclick="app.setState({currentView: 'history'})" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
    üïê Storico
</button>
                            </div>
                        </div>
                        
                        <div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4 mb-6">
                            <div class="flex">
                                <div class="flex-shrink-0">üî•</div>
                                <div class="ml-3">
                                    <p class="text-sm">
                                        <strong>Firebase Real-Time attivo!</strong><br/>
                                        Sincronizzazione multi-device funzionante. Apri l'app su smartphone, tablet o altri PC per vedere gli aggiornamenti in tempo reale.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg p-8 shadow-sm border">
                            <h2 class="text-lg font-semibold mb-6 text-center text-gray-700">Mappa Tavoli</h2>
                            
                            <div class="grid gap-4 justify-center" style="grid-template-columns: repeat(4, 1fr); max-width: 800px; margin: 0 auto;">
                                ${this.tables.map(table => {
                                    const hasDraftOrder = this.state.orders[table.id]?.length > 0;
                                    const activeOrder = this.state.activeOrders.find(order => order.tableNumber === table.id);
                                    
                                    let bgColor = 'bg-gradient-to-br from-gray-50 to-gray-100 border-2 border-gray-200';
                                    let statusText = 'Libero';
                                    
                                    if (hasDraftOrder) {
                                        bgColor = 'bg-gradient-to-br from-yellow-400 to-yellow-600 text-white shadow-lg';
                                        statusText = 'Bozza';
                                    } else if (activeOrder) {
                                        bgColor = 'bg-gradient-to-br from-orange-400 to-orange-600 text-white shadow-lg';
                                        statusText = 'In Cucina';
                                    }
                                    
                                    return `
                                        <div onclick="app.selectTable(${table.id})" class="relative w-24 h-24 rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all transform hover:scale-105 hover:shadow-lg ${bgColor} hover:border-blue-400">
                                            <div class="font-bold text-lg">${table.number}</div>
                                            <div class="text-xs flex items-center gap-1 opacity-80">
                                                üë• ${table.seats}
                                            </div>
                                            
                                            ${(hasDraftOrder || activeOrder) ? `
                                                <div class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-lg">
                                                    ${hasDraftOrder 
                                                        ? this.state.orders[table.id].reduce((sum, item) => sum + item.quantity, 0)
                                                        : activeOrder?.items.reduce((sum, item) => sum + item.quantity, 0) || 0
                                                    }
                                                </div>
                                            ` : ''}
                                            
                                            <div class="absolute bottom-1 text-xs font-medium">
                                                ${statusText}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderMenuView() {
                const table = this.tables.find(t => t.id === this.state.selectedTable);
                const currentOrder = this.getCurrentOrder();
                
                return `
                    <div class="flex flex-col h-screen bg-gray-50">
                        <div class="bg-white shadow-sm p-4 flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <button onclick="app.setState({currentView: 'tables'})" class="p-2 hover:bg-gray-100 rounded-lg">‚úï</button>
                                <h1 class="text-xl font-bold">Tavolo ${table?.number}</h1>
                            </div>
                            
                            ${currentOrder.length > 0 ? `
                                <div class="flex items-center gap-4">
                                    <div class="text-lg font-bold text-green-600">‚Ç¨${this.calculateTotal().toFixed(2)}</div>
                                    <button onclick="app.printOrder()" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                                        üñ®Ô∏è Invia in Cucina
                                    </button>
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex flex-1 overflow-hidden">
                            <div class="w-1/2 bg-white border-r overflow-y-auto">
                                ${Object.entries(this.menuCategories).map(([category, items]) => `
                                    <div class="p-4 border-b">
                                        <h3 class="font-bold text-lg mb-3 text-gray-800">${category}</h3>
                                        <div class="grid gap-2">
                                            ${items.map(item => `
                                                <div onclick="app.addToOrder({id:${item.id},name:'${item.name.replace(/'/g, "\\'")}',price:${item.price},ingredients:'${item.ingredients ? item.ingredients.replace(/'/g, "\\'") : ''}',description:'${item.description ? item.description.replace(/'/g, "\\'") : ''}'})" class="flex justify-between items-start p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-200 border border-transparent transition-all">
                                                    <div class="flex-1">
                                                        <div class="font-medium">${item.name}</div>
                                                        <div class="text-green-600 font-bold">‚Ç¨${item.price.toFixed(2)}</div>
                                                        ${item.ingredients ? `<div class="text-xs text-gray-600 mt-1">${item.ingredients}</div>` : ''}
                                                        ${item.description ? `<div class="text-xs text-gray-500 mt-1 italic">${item.description}</div>` : ''}
                                                    </div>
                                                    <div class="ml-3 flex-shrink-0">‚ûï</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="w-1/2 bg-white p-4 overflow-y-auto">
                                <h3 class="font-bold text-lg mb-4">Ordine Corrente</h3>
                                
                                ${currentOrder.length === 0 ? `
                                    <div class="text-center text-gray-500 mt-8">
                                        <div class="text-4xl mb-4">üìã</div>
                                        <p>Seleziona gli articoli dal menu</p>
                                    </div>
                                ` : `
                                    <div class="space-y-3">
                                        ${currentOrder.map(item => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div class="flex-1">
                                                    <div class="font-medium">${item.name}</div>
                                                    <div class="text-sm text-gray-600">‚Ç¨${item.price.toFixed(2)} cad.</div>
                                                </div>
                                                
                                                <div class="flex items-center gap-3">
                                                    <button onclick="app.removeFromOrder(${item.id})" class="p-1 hover:bg-red-100 rounded text-red-600">‚ûñ</button>
                                                    <span class="font-bold w-8 text-center">${item.quantity}</span>
                                                    <button onclick="app.addToOrder({id:${item.id},name:'${item.name.replace(/'/g, "\\'")}',price:${item.price},ingredients:'${item.ingredients ? item.ingredients.replace(/'/g, "\\'") : ''}',description:'${item.description ? item.description.replace(/'/g, "\\'") : ''}'})" class="p-1 hover:bg-green-100 rounded text-green-600">‚ûï</button>
                                                    <div class="font-bold text-green-600 w-16 text-right">‚Ç¨${(item.price * item.quantity).toFixed(2)}</div>
                                                </div>
                                            </div>
                                        `).join('')}
                                        
                                        <div class="border-t pt-3 mt-4">
                                            <div class="flex justify-between items-center text-xl font-bold">
                                                <span>Totale:</span>
                                                <span class="text-green-600">‚Ç¨${this.calculateTotal().toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            renderKitchenView() {
                return `
                    <div class="p-6 bg-gray-900 min-h-screen text-white">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h1 class="text-3xl font-bold">üë®‚Äçüç≥ Dashboard Cucina</h1>
                                <div class="text-sm text-gray-300 mt-1">${this.state.syncStatus} ‚Ä¢ Real-time sync attivo</div>
                            </div>
                            <div class="flex gap-3">
                                <div class="bg-red-600 px-4 py-2 rounded-lg">
                                    <span class="font-bold">Ordini Attivi: ${this.state.activeOrders.length}</span>
                                </div>
                                <button onclick="app.setState({currentView: 'tables'})" class="flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                                    ‚úï Torna ai Tavoli
                                </button>
                            </div>
                        </div>
                        
                        ${this.state.activeOrders.length === 0 ? `
                            <div class="text-center text-gray-400 mt-20">
                                <div class="text-6xl mb-4">üçΩÔ∏è</div>
                                <p class="text-xl">Nessun ordine in preparazione</p>
                                <p class="text-gray-500">Gli ordini appariranno qui quando vengono inviati</p>
                            </div>
                        ` : `
                            <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                                ${this.state.activeOrders.map(order => {
                                    const table = this.tables.find(t => t.id === order.tableNumber);
                                    
                                    return `
                                        <div class="rounded-lg p-6 border-2 ${order.isModified ? 'bg-yellow-800 border-yellow-400 ring-2 ring-yellow-400' : 'bg-orange-800 border-orange-400'}">
                                            <div class="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 class="text-2xl font-bold">Tavolo ${table?.number}</h3>
                                                    <p class="text-sm opacity-75">${new Date(order.timestamp).toLocaleTimeString('it-IT')}</p>
                                                    ${order.isModified ? `<div class="bg-yellow-500 text-black px-2 py-1 rounded text-xs font-bold mt-1">‚ö†Ô∏è ORDINE MODIFICATO v.${order.version}</div>` : ''}
                                                </div>
                                                <div class="text-right">
                                                    <div class="text-2xl font-bold">‚Ç¨${order.total.toFixed(2)}</div>
                                                    <div class="text-sm opacity-75">${order.items.reduce((sum, item) => sum + item.quantity, 0)} articoli</div>
                                                </div>
                                            </div>
                                            
                                            <div class="space-y-2 mb-4">
                                                ${order.items.map(item => `
                                                    <div class="flex justify-between">
                                                        <span class="font-medium">${item.quantity}x ${item.name}</span>
                                                        <span>‚Ç¨${(item.price * item.quantity).toFixed(2)}</span>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            
                                            <button onclick="app.closeOrderFromKitchen(${order.id})" class="w-full bg-green-600 hover:bg-green-700 px-4 py-3 rounded font-bold">
                                                üí∞ Cliente ha Pagato - Libera Tavolo
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            }
            
            selectTable(tableId) {
                const activeOrder = this.state.activeOrders.find(order => order.tableNumber === tableId);
                if (activeOrder) {
                    this.closeOrderFromWaiter(tableId);
                } else {
                    this.setState({ selectedTable: tableId, currentView: 'menu' });
                }
            }
            
            closeOrderFromWaiter(tableNumber) {
                const orderToClose = this.state.activeOrders.find(order => order.tableNumber == tableNumber);
                
                if (!orderToClose) {
                    alert('‚ùå Nessun ordine attivo per questo tavolo!');
                    return;
                }

                const confirmMsg = `‚ö†Ô∏è LIBERARE TAVOLO ${tableNumber}?\n\nATTENZIONE: Confermi che il cliente ha PAGATO?\n\nOrdine: ‚Ç¨${orderToClose.total.toFixed(2)}\nArticoli: ${orderToClose.items.reduce((sum, item) => sum + item.quantity, 0)}\n\nClicca OK solo se il cliente ha gi√† pagato.`;
                
                if (!window.confirm(confirmMsg)) {
                    return;
                }

                const closedOrder = {
                    ...orderToClose,
                    state: 'paid',
                    closedAt: new Date(),
                    closedBy: 'waiter'
                };
                
                const updatedHistory = [closedOrder, ...this.state.orderHistory];
                const updatedActiveOrders = this.state.activeOrders.filter(order => order.id !== orderToClose.id);
                
                this.setState({
                    orderHistory: updatedHistory,
                    activeOrders: updatedActiveOrders
                });
                
                firebaseService.update('orderHistory', updatedHistory);
                firebaseService.update('activeOrders', updatedActiveOrders);
                
                alert(`‚úÖ Tavolo ${tableNumber} liberato dal cameriere!`);
            }
            
            attachEventListeners() {
                // Gli event listeners sono gestiti direttamente nell'HTML tramite onclick
            }
        }
        
        // Inizializza l'app quando Firebase √® pronto
        window.addEventListener('firebaseReady', () => {
            setTimeout(() => {
                const app = new ZenzoBarApp();
                window.app = app;
            }, 500);
        });
        
        // Fallback se Firebase non si carica entro 3 secondi
        setTimeout(() => {
            if (!window.app) {
                const app = new ZenzoBarApp();
                window.app = app;
            }
        }, 3000);
    </script>
</body>
</html>
